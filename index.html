<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ColorShop | Cloud Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<style>
  :root { --p: #6a5cff; --bg: #f6f7fb; --card: #fff; --txt: #333; --err: #ff4d4d; --brd: #eeeeee; }
  [data-theme="dark"] { --bg: #121212; --card: #1e1e1e; --txt: #f0f0f0; --brd: #333; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--txt); transition: 0.3s; padding-bottom: 80px; }
  header { background: var(--p); color: #fff; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
  .tools { background: var(--card); border-bottom: 1px solid var(--brd); padding: 10px 15px; }
  .search-row { display: flex; gap: 8px; margin-bottom: 10px; }
  #search-bar { flex: 2; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--brd); background: var(--bg); color: var(--txt); }
  .cats { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; padding-bottom: 5px; }
  .cat-btn { padding: 6px 15px; border-radius: 20px; border: 1px solid var(--brd); background: var(--card); color: var(--txt); font-size: 12px; white-space: nowrap; cursor: pointer; }
  .cat-btn.active { background: var(--p); color: #fff; border-color: var(--p); }
  .products { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; padding: 15px; min-height: 200px; }
  .product { background: var(--card); padding: 12px; border-radius: 15px; text-align: center; border: 1px solid var(--brd); position: relative; }
  .gallery-container { width: 100%; height: 180px; position: relative; border-radius: 10px; overflow: hidden; background: #eee; margin-bottom: 10px; }
  .gallery-container img { width: 100%; height: 100%; object-fit: cover; }
  .nav-tap { position: absolute; top: 0; width: 30%; height: 100%; z-index: 5; }
  .nav-left { left: 0; }
  .nav-right { right: 0; }
  
  /* Admin & Cart Panels */
  #admin-panel { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 25px; border-radius: 20px; border: 2px solid var(--p); z-index: 3000; width: 92%; max-width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .cart { position: fixed; right: -100%; top: 0; width: 100%; max-width: 380px; height: 100%; background: var(--card); padding: 20px; transition: 0.4s; z-index: 2000; overflow-y: auto; }
  .cart.open { right: 0; box-shadow: -5px 0 20px rgba(0,0,0,0.1); }
  .cart-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--brd); align-items: center; font-size: 14px; }
  
  .del-box { flex: 1; border: 1px solid var(--brd); padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; font-size: 13px; }
  .del-box.active { border-color: var(--p); background: rgba(106, 92, 255, 0.1); color: var(--p); }
  
  .btn-p { background: var(--p); color: #fff; width: 100%; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
  input, select { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid var(--brd); border-radius: 10px; background: var(--bg); color: var(--txt); }
  #debug-log { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9); color: #00ff00; font-family: monospace; font-size: 10px; padding: 5px; z-index: 9999; max-height: 40px; overflow: hidden; pointer-events: none; }
</style>
</head>
<body data-theme="light">

<div id="debug-log">System Ready...</div>

<header>
  <h2 id="admin-trigger">ColorShop</h2>
  <div style="display:flex; align-items:center; gap:8px;">
    <button onclick="toggleTheme()" style="background:none; border:none; color:#fff; font-size:20px;">üåì</button>
    <button onclick="toggleCart()" style="background:#fff; color:var(--p); border:none; padding: 6px 12px; border-radius:8px; font-weight:bold;">üõí <span id="cart-count">0</span></button>
  </div>
</header>

<div class="tools">
  <div class="search-row"><input type="text" id="search-bar" placeholder="Search..." oninput="draw()"></div>
  <div class="cats" id="cat-list"></div>
</div>

<div class="products" id="grid"></div>

<div id="admin-panel">
  <h3 style="margin-top:0">Add Product</h3>
  <input id="n-name" placeholder="Product Name">
  <input id="n-price" type="number" placeholder="Price (DA)">
  <input id="n-cat" placeholder="Category">
  <input id="n-files" type="file" multiple accept="image/*">
  <button id="up-btn" onclick="addItem()" class="btn-p">Upload to Cloud</button>
  <button onclick="logout()" class="btn-p" style="background:#eee; color:#333">Cancel</button>
</div>

<div class="cart" id="cart-panel">
  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
    <h3 style="margin:0">Checkout</h3>
    <button onclick="toggleCart()" style="background:none; border:none; font-size:28px; cursor:pointer;">&times;</button>
  </div>
  
  <div id="cart-list" style="margin-top:10px;">
    <p style="text-align:center; color:#999; margin-top:20px;">Your cart is empty.</p>
  </div>
  
  <div style="border-top:2px solid var(--p); margin-top:15px; padding-top:10px;">
    <h4 style="display:flex; justify-content:space-between;">Total: <span id="cart-total">0</span> DA</h4>
  </div>

  <input id="c-name" placeholder="Customer Name">
  <input id="c-phone" type="tel" placeholder="Phone Number">
  <select id="c-wilaya"></select>
  
  <div style="display:flex; gap:10px; margin-top:10px;">
    <div class="del-box active" id="m-home" onclick="setDel('Home')">üè† Home</div>
    <div class="del-box" id="m-desk" onclick="setDel('Stop Desk')">üì¶ Desk</div>
  </div>
  
  <button class="btn-p" onclick="checkout()" style="background:#333; margin-top:20px;">Send Order via Email</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC8wtssEyyIgD5x3JLV_miPsoMrgvD9EDM",
  databaseURL: "https://colorshop-933e7-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "colorshop-933e7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const wilayas = ["01 Adrar","02 Chlef","03 Laghouat","04 Oum El Bouaghi","05 Batna","06 B√©ja√Øa","07 Biskra","08 B√©char","09 Blida","10 Bouira","11 Tamanrasset","12 T√©bessa","13 Tlemcen","14 Tiaret","15 Tizi Ouzou","16 Algiers","17 Djelfa","18 Jijel","19 S√©tif","20 Sa√Øda","21 Skikda","22 Sidi Bel Abb√®s","23 Annaba","24 Guelma","25 Constantine","26 M√©d√©a","27 Mostaganem","28 M'Sila","29 Mascara","30 Ouargla","31 Oran","32 El Bayadh","33 Illizi","34 Bordj Bou Arr√©ridj","35 Boumerd√®s","36 El Tarf","37 Tindouf","38 Tissemsilt","39 El Oued","40 Khenchela","41 Souk Ahras","42 Tipaza","43 Mila","44 A√Øn Defla","45 Na√¢ma","46 A√Øn T√©mouchent","47 Gharda√Øa","48 Relizane","49 El M'Ghair","50 El Meniaa","51 Ouled Djellal","52 Bordj Baji Mokhtar","53 B√©ni Abb√®s","54 Timimoun","55 Touggourt","56 Djanet","57 In Salah","58 In Guezzam"];
const wSelect = document.getElementById('c-wilaya');
wilayas.forEach(w => { let o = document.createElement('option'); o.value=w; o.text=w; wSelect.add(o); });

let items = [], cart = [], isAdmin = false, curCat = "All", galleryState = {}, delMode = "Home";

// Load Products
db.ref('products').on('value', (snap) => {
    const data = snap.val();
    items = data ? Object.keys(data).map(k => ({...data[k], fbKey: k})) : [];
    draw();
});

function draw() {
    const g = document.getElementById("grid");
    g.innerHTML = "";
    const filtered = items.filter(i => (curCat==="All" || i.cat===curCat));
    if(filtered.length === 0) g.innerHTML = "<p style='grid-column:1/-1;text-align:center;color:#999;margin-top:50px;'>No products available.</p>";
    
    filtered.forEach(p => {
        const idx = galleryState[p.id] || 0;
        const img = p.imgs ? p.imgs[idx] : '';
        g.innerHTML += `<div class="product">
            ${isAdmin ? `<button onclick="deleteItem('${p.fbKey}')" style="position:absolute;top:5px;right:5px;background:red;color:white;border:none;border-radius:50%;width:25px;height:25px;">&times;</button>` : ''}
            <div class="gallery-container"><img src="${img}"></div>
            <h4 style="margin:8px 0">${p.name}</h4>
            <p style="font-weight:bold;color:var(--p);margin:0 0 10px">${p.price} DA</p>
            <button class="btn-p" style="margin:0" onclick="addToCart(${p.id})">Add to Cart</button>
        </div>`;
    });
    updateCats();
}

function addToCart(id) {
    const p = items.find(x => x.id === id);
    const exists = cart.find(x => x.id === id);
    if(exists) exists.qty++; else cart.push({...p, qty: 1});
    updateCart();
    document.getElementById('debug-log').innerText = "Added: " + p.name;
}

function updateCart() {
    const list = document.getElementById('cart-list');
    let total = 0;
    if(cart.length === 0) {
        list.innerHTML = "<p style='text-align:center;color:#999;margin-top:20px;'>Your cart is empty.</p>";
    } else {
        list.innerHTML = cart.map(item => {
            total += item.price * item.qty;
            return `<div class="cart-item">
                <div style="flex:1"><b>${item.name}</b><br><small>${item.price} DA x ${item.qty}</small></div>
                <div style="font-weight:bold;margin:0 10px">${(item.price * item.qty).toLocaleString()} DA</div>
                <button onclick="removeFromCart(${item.id})" style="background:none;border:none;color:red;font-size:18px;">&times;</button>
            </div>`;
        }).join('');
    }
    document.getElementById('cart-total').innerText = total.toLocaleString();
    document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.qty, 0);
}

function removeFromCart(id) {
    cart = cart.filter(x => x.id !== id);
    updateCart();
}

function setDel(m) {
    delMode = m;
    document.getElementById('m-home').className = m==='Home'?'del-box active':'del-box';
    document.getElementById('m-desk').className = m==='Stop Desk'?'del-box active':'del-box';
}

function checkout() {
    const name = document.getElementById('c-name').value;
    const phone = document.getElementById('c-phone').value;
    const wilaya = document.getElementById('c-wilaya').value;
    if(!name || !phone || cart.length === 0) return alert("Please fill Name, Phone and add items!");
    
    let body = `New Order from ${name}\nPhone: ${phone}\nWilaya: ${wilaya}\nDelivery: ${delMode}\n\nItems:`;
    cart.forEach(i => body += `\n- ${i.name} (x${i.qty}) - Total: ${i.price * i.qty} DA`);
    body += `\n\nGrand Total: ${document.getElementById('cart-total').innerText} DA`;
    
    window.location.href = `mailto:fullshopdz@gmail.com?subject=New_Order_${name}&body=${encodeURIComponent(body)}`;
}

function toggleCart() { document.getElementById('cart-panel').classList.toggle('open'); }

// Admin Logic
let taps = 0, timer;
document.getElementById('admin-trigger').onclick = () => {
    taps++; clearTimeout(timer);
    if(taps === 4) { if(prompt("Pass:") === "12346") { isAdmin = true; document.getElementById('admin-panel').style.display='block'; draw(); } taps=0; }
    timer = setTimeout(() => taps = 0, 1000);
};

async function addItem() {
    const n = document.getElementById('n-name').value, p = document.getElementById('n-price').value, c = document.getElementById('n-cat').value || "All", f = document.getElementById('n-files').files;
    if(!n || !p || f.length === 0) return alert("Fill all fields!");
    const btn = document.getElementById('up-btn');
    btn.disabled = true; btn.innerText = "Uploading...";
    try {
        let imgs = [];
        for(let file of f) {
            const b64 = await new Promise(r => {
                const rd = new FileReader(); rd.readAsDataURL(file);
                rd.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const can = document.createElement('canvas'); const max = 600; let w = img.width, h = img.height;
                        if(w > max) { h *= max/w; w = max; } can.width = w; can.height = h;
                        can.getContext('2d').drawImage(img, 0, 0, w, h); r(can.toDataURL('image/jpeg', 0.6));
                    }
                }
            });
            imgs.push(b64);
        }
        await db.ref('products').push({ id: Date.now(), name: n, price: parseInt(p), cat: c, imgs: imgs });
        alert("Product Added!");
        document.getElementById('n-name').value = ""; document.getElementById('n-price').value = "";
    } catch (e) { alert(e.message); }
    finally { btn.disabled = false; btn.innerText = "Upload to Cloud"; }
}

function deleteItem(key) { if(confirm("Delete?")) db.ref('products/'+key).remove(); }
function logout() { isAdmin = false; document.getElementById('admin-panel').style.display='none'; draw(); }
function updateCats() {
    const categories = ["All", ...new Set(items.map(i => i.cat))];
    document.getElementById('cat-list').innerHTML = categories.map(c => `<button class="cat-btn ${curCat===c?'active':''}" onclick="curCat='${c}'; draw()">${c}</button>`).join('');
}
function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='dark'?'light':'dark'); }
</script>
</body>
</html>
